<!-- core/templates/session_detail.html -->

{% extends 'base.html' %}

{% block title %}
    {{ session.title }}
{% endblock %}

{% block content %}
    <h1>{{ session.title }}</h1>

    <div class="conversation">
        {% for query in queries %}
            <div class="message user">
                <div class="bubble">{{ query.question }}</div>
            </div>
            <div class="message bot">
                <div class="bubble">{{ query.answer|safe }}</div>
            </div>
        {% endfor %}
    </div>

    <div class="fixed-footer">
        <div class="input-area">
            <form method="post">
                {% csrf_token %}
                <input type="text" name="question" placeholder="Ask a question" id="question-input">
                <button type="submit">Submit</button>
            </form>
        </div>
    </div>


    <script>
        function editSessionTitle(element) {
            const sessionId = element.dataset.sessionId;
            const currentTitle = element.querySelector('a').innerText;

            // Prompt user for a new title
            const newTitle = prompt("Edit session title:", currentTitle);
            if (newTitle && newTitle !== currentTitle) {
                // Send an AJAX request to update the session title
                fetch(`/update-session-title/${sessionId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ title: newTitle })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        element.querySelector('a').innerText = newTitle;
                    } else {
                        alert("Failed to update session title.");
                    }
                });
            }
        }

        function deleteSession(element) {
            const sessionId = element.dataset.sessionId;
            if (confirm("Are you sure you want to delete this session?")) {
                fetch(`/delete-session/${sessionId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = "{% url 'home' %}";
                    } else {
                        alert("Failed to delete session.");
                    }
                });
            }
        }
    </script>
{% endblock %}